From: Thomas Gleixner <tglx@linutronix.de>
Subject: KVM: SVM: Move spec control call after restore of GS
Patch-mainline: not yet, queued in subsystem tree
References: bsc#1087082 CVE-2018-3639

svm_vcpu_run() invokes x86_spec_ctrl_restore_host() after VMEXIT, but
before the host GS is restored. x86_spec_ctrl_restore_host() uses 'current'
to determine the host SSBD state of the thread. 'current' is GS based, but
host GS is not yet restored and the access causes a triple fault.

Move the call after the host GS restore.

Fixes: 5cf687548705 ("x86/bugs, KVM: Support the combination of guest and host IBRS")
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Acked-by: Joerg Roedel <jroedel@suse.de>
---
 arch/x86/kvm/svm.c |   24 ++++++++++++------------
 1 file changed, 12 insertions(+), 12 deletions(-)

--- a/arch/x86/kvm/svm.c
+++ b/arch/x86/kvm/svm.c
@@ -3922,9 +3922,6 @@ static void svm_vcpu_run(struct kvm_vcpu
 #endif
 		);
 
-	if (x86_ibrs_enabled())
-		x86_spec_ctrl_restore_host(svm->spec_ctrl);
-
 	/* Eliminate branch target predictions from guest mode */
 	vmexit_fill_RSB();
 
@@ -3939,6 +3936,9 @@ static void svm_vcpu_run(struct kvm_vcpu
 
 	reload_tss(vcpu);
 
+	if (x86_ibrs_enabled())
+		x86_spec_ctrl_restore_host(svm->spec_ctrl);
+
 	local_irq_disable();
 
 	vcpu->arch.cr2 = svm->vmcb->save.cr2;
