From: Martin Schwidefsky <schwidefsky@de.ibm.com>
Subject: s390/lib: use expoline for all bcr instructions
Patch-mainline: v4.19-rc1
Git-commit: 5eda25b10297684c1f46a14199ec00210f3c346e
References: bnc#1106934, LTC#171029

Description:  kernel: improve spectre mitigation
Symptom:      -
Problem:      The upstream kernel has a few more spectre related updates
              and fixes which are relevant for the various distribution
              targets as well. The most notable improvement is the
              etoken support.
Solution:     Backport upstream patches
Reproduction: -

Upstream-Description:

              s390/lib: use expoline for all bcr instructions

              The memove, memset, memcpy, __memset16, __memset32 and __memset64
              function have an additional indirect return branch in form of a
              "bzr" instruction. These need to use expolines as well.

              Cc: <stable@vger.kernel.org> # v4.17+
              Fixes: 97489e0663 ("s390/lib: use expoline for indirect branches")
              Reviewed-by: Heiko Carstens <heiko.carstens@de.ibm.com>
              Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>


Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
Acked-by: Johannes Thumshirn <jthumshirn@suse.de>
---
 arch/s390/net/bpf_jit_comp.c |    2 --
 1 file changed, 2 deletions(-)

--- a/arch/s390/net/bpf_jit_comp.c
+++ b/arch/s390/net/bpf_jit_comp.c
@@ -522,8 +522,6 @@ static void bpf_jit_epilogue(struct bpf_
 			/* br %r1 */
 			_EMIT2(0x07f1);
 		} else {
-			/* larl %r1,.+14 */
-			EMIT6_PCREL_RILB(0xc0000000, REG_1, jit->prg + 14);
 			/* ex 0,S390_lowcore.br_r1_tampoline */
 			EMIT4_DISP(0x44000000, REG_0, REG_0,
 				   offsetof(struct _lowcore, br_r1_trampoline));
