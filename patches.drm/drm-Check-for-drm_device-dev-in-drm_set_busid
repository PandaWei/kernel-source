From 22a884cfe5a49b6fd63f10ff137906028b4cf923 Mon Sep 17 00:00:00 2001
From: Daniel Vetter <daniel.vetter@ffwll.ch>
Date: Wed, 21 Jun 2017 15:04:29 +0200
Subject: [PATCH] drm: Check for drm_device->dev in drm_set_busid
Git-commit: 22a884cfe5a49b6fd63f10ff137906028b4cf923
Patch-mainline: v4.14-rc1
References: FATE#322643 bsc#1055900

I've failed to remember that we have virtual drivers like vgem which
have no underlying struct device. Fix this asap.

Reported-by: Chris Wilson <chris@chris-wilson.co.uk>
Cc: Chris Wilson <chris@chris-wilson.co.uk>
Reviewed-by: Chris Wilson <chris@chris-wilson.co.uk>
Fixes: 5c484cee7ef9 ("drm: Remove drm_driver->set_busid hook")
Cc: Thierry Reding <treding@nvidia.com>
Cc: Daniel Vetter <daniel.vetter@intel.com>
Signed-off-by: Daniel Vetter <daniel.vetter@intel.com>
Link: http://patchwork.freedesktop.org/patch/msgid/20170621130429.20537-1-daniel.vetter@ffwll.ch
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/gpu/drm/drm_ioctl.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/drivers/gpu/drm/drm_ioctl.c
+++ b/drivers/gpu/drm/drm_ioctl.c
@@ -149,7 +149,8 @@ static int drm_set_busid(struct drm_devi
 			drm_unset_busid(dev, master);
 			return ret;
 		}
-	} else if (dev_is_pci(dev->dev)) {
+	} else if (dev->dev && dev_is_pci(dev->dev)) {
+
 		ret = drm_pci_set_busid(dev, master);
 		if (ret) {
 			drm_unset_busid(dev, master);
