From 680273879d125d644831b8de42c66576e6290378 Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Fri, 27 Oct 2017 12:06:16 +0100
Subject: [PATCH] drm/i915: Move parking-while-active warning to intel_engines_park()
Git-commit: 680273879d125d644831b8de42c66576e6290378
Patch-mainline: v4.16-rc1
References: FATE#322643 bsc#1055900

We will want to break this down to give detailed per-engine warnings as
to why we still think we are active as we attempt to park the engines.
For the first step, just move the warning verbatim from the idle-worker
to intel_engines_park().

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
Link: https://patchwork.freedesktop.org/patch/msgid/20171027110617.31745-3-chris@chris-wilson.co.uk
Reviewed-by: Mika Kuoppala <mika.kuoppala@linux.intel.com>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/gpu/drm/i915/i915_gem.c        |    7 -------
 drivers/gpu/drm/i915/intel_engine_cs.c |    7 +++++++
 2 files changed, 7 insertions(+), 7 deletions(-)

--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -3308,13 +3308,6 @@ i915_gem_idle_work_handler(struct work_s
 	 */
 	synchronize_irq(dev_priv->drm.irq);
 
-	/*
-	 * We are committed now to parking the engines, make sure there
-	 * will be no more interrupts arriving later.
-	 */
-	if (!intel_engines_are_idle(dev_priv))
-		DRM_ERROR("Timeout waiting for engines to idle\n");
-
 	intel_engines_park(dev_priv);
 	i915_gem_timelines_mark_idle(dev_priv);
 
--- a/drivers/gpu/drm/i915/intel_engine_cs.c
+++ b/drivers/gpu/drm/i915/intel_engine_cs.c
@@ -1621,6 +1621,13 @@ void intel_engines_park(struct drm_i915_
 	struct intel_engine_cs *engine;
 	enum intel_engine_id id;
 
+	/*
+	 * We are committed now to parking the engines, make sure there
+	 * will be no more interrupts arriving later.
+	 */
+	if (!intel_engines_are_idle(dev_priv))
+		DRM_ERROR("Timeout waiting for engines to idle\n");
+
 	for_each_engine(engine, i915, id) {
 		if (engine->park)
 			engine->park(engine);
