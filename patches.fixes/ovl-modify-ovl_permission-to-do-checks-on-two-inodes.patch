From c0ca3d70e8d3cf81e2255a217f7ca402f5ed0862 Mon Sep 17 00:00:00 2001
From: Vivek Goyal <vgoyal@redhat.com>
Date: Fri Jul  1 16:34:27 2016 -0400
Subject: [PATCH] ovl: modify ovl_permission() to do checks on two inodes
Git-commit: c0ca3d70e8d3cf81e2255a217f7ca402f5ed0862
References: bsc#1106512, bsc#1107299
Patch-mainline: v4.8-rc1

Right now ovl_permission() calls __inode_permission(realinode), to do
permission checks on real inode and no checks are done on overlay inode.

Modify it to do checks both on overlay inode as well as underlying inode.
Checks on overlay inode will be done with the creds of calling task while
checks on underlying inode will be done with the creds of mounter.

Signed-off-by: Vivek Goyal <vgoyal@redhat.com>
Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
Acked-by: Goldwyn Rodrigues <rgoldwyn@suse.com>

diff --git a/fs/overlayfs/inode.c b/fs/overlayfs/inode.c
index b8bc1fd4a008..223544600539 100644

--- a/fs/overlayfs/inode.c
+++ b/fs/overlayfs/inode.c
@@ -10,6 +10,7 @@
 #include <linux/fs.h>
 #include <linux/slab.h>
 #include <linux/xattr.h>
+#include <linux/cred.h>
 #include "overlayfs.h"
 
 static int ovl_copy_up_truncate(struct dentry *dentry)
@@ -93,6 +94,7 @@ int ovl_permission(struct inode *inode, int mask)
 	struct inode *realinode;
 	struct dentry *realdentry;
 	bool is_upper;
+	const struct cred *old_cred;
 	int err;
 
 	if (S_ISDIR(inode->i_mode)) {
@@ -167,13 +169,22 @@ int ovl_permission(struct inode *inode, int mask)
 		    (S_ISREG(mode) || S_ISDIR(mode) || S_ISLNK(mode)))
 			goto out_dput;
 	}
+	/*
+	 * Check overlay inode with the creds of task and underlying inode
+	 * with creds of mounter
+	 */
+	err = generic_permission(inode, mask);
+	if (err)
+		goto out_dput;
 
+	old_cred = ovl_override_creds(inode->i_sb);
 	if (!is_upper && !special_file(realinode->i_mode) && mask & MAY_WRITE) {
 		mask &= ~(MAY_WRITE | MAY_APPEND);
 		/* Make sure mounter can read file for copy up later */
 		mask |= MAY_READ;
 	}
 	err = __inode_permission(realinode, mask);
+	revert_creds(old_cred);
 out_dput:
 	dput(alias);
 	return err;
