From: Amir Goldstein <amir73il@gmail.com>
Date: Tue, 11 Jul 2017 15:58:35 +0300
Subject: [PATCH] ovl: fix random return value on mount
References: bsc#1099993
Git-commit: 8fc646b44385ff0a9853f6590497e43049eeb311
Patch-mainline: v4.13-rc2

On failure to prepare_creds(), mount fails with a random
return value, as err was last set to an integer cast of
a valid lower mnt pointer or set to 0 if inodes index feature
is enabled.

Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
Fixes: 3fe6e52f0626 ("ovl: override creds with the ones from ...")
Cc: <stable@vger.kernel.org> # v4.7
Signed-off-by: Amir Goldstein <amir73il@gmail.com>
Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
Acked-by: Goldwyn Rodrigues <rgoldwyn@suse.com>

---
 fs/overlayfs/super.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/fs/overlayfs/super.c b/fs/overlayfs/super.c
index f85e73f49543..6a06c35d6e86 100644
--- a/fs/overlayfs/super.c
+++ b/fs/overlayfs/super.c
@@ -1182,11 +1182,11 @@ static int ovl_fill_super(struct super_block *sb, void *data, int silent)
 	else
 		sb->s_d_op = &ovl_dentry_operations;
 
+	err = -ENOMEM;
 	ufs->creator_cred = prepare_creds();
 	if (!ufs->creator_cred)
 		goto out_put_lower_mnt;
 
-	err = -ENOMEM;
 	oe = ovl_alloc_entry(numlower);
 	if (!oe)
 		goto out_put_cred;
-- 
2.16.4

