From 83e10a5bcdf2c38778de778deb9793e5e0991cf9 Mon Sep 17 00:00:00 2001
From: Aurelien Aptel <aaptel@suse.com>
Date: Thu, 26 Apr 2018 12:43:14 +0200
Subject: [PATCH] CIFS: fix bad/NULL ptr dereferencing in SMB2_sess_setup()
Patch-mainline: Never, code diverged too much from upstream
References: bsc#1090123

Signed-off-by: Aurelien Aptel <aaptel@suse.com>
Reviewed-by: Paulo Alcantara <palcantara@suse.de>

---
 fs/cifs/smb2pdu.c   | 2 +-
 fs/cifs/transport.c | 4 +++-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/fs/cifs/smb2pdu.c b/fs/cifs/smb2pdu.c
index 51f3acdd213b..8637a9faddce 100644
--- a/fs/cifs/smb2pdu.c
+++ b/fs/cifs/smb2pdu.c
@@ -852,7 +852,6 @@ ssetup_ntlmssp_authenticate:
 
 	kfree(security_blob);
 	rsp = (struct smb2_sess_setup_rsp *)iov[0].iov_base;
-	ses->Suid = rsp->hdr.sync_hdr.SessionId;
 	if (resp_buftype != CIFS_NO_BUFFER &&
 	    rsp->hdr.sync_hdr.Status == STATUS_MORE_PROCESSING_REQUIRED) {
 		if (phase != NtLmNegotiate) {
@@ -885,6 +884,7 @@ ssetup_ntlmssp_authenticate:
 	if (rc != 0)
 		goto ssetup_exit;
 
+	ses->Suid = rsp->hdr.sync_hdr.SessionId;
 	ses->session_flags = le16_to_cpu(rsp->SessionFlags);
 ssetup_exit:
 	free_rsp_buf(resp_buftype, rsp);
diff --git a/fs/cifs/transport.c b/fs/cifs/transport.c
index 8e427c223794..db56d672895c 100644
--- a/fs/cifs/transport.c
+++ b/fs/cifs/transport.c
@@ -810,8 +810,10 @@ SendReceive2(const unsigned int xid, struct cifs_ses *ses,
 	int rc;
 
 	new_iov = kmalloc(sizeof(struct kvec) * (n_vec + 1), GFP_KERNEL);
-	if (!new_iov)
+	if (!new_iov) {
+		*resp_buf_type = CIFS_NO_BUFFER;
 		return -ENOMEM;
+	}
 
 	/* 1st iov is a RFC1001 length followed by the rest of the packet */
 	memcpy(new_iov + 1, iov, (sizeof(struct kvec) * n_vec));
-- 
2.13.6

