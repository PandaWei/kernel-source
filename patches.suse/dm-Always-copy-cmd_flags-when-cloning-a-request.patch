From: Hannes Reinecke <hare@suse.de>
Date: Wed, 4 Apr 2018 14:12:32 +0200
Subject: [PATCH] dm: Always copy cmd_flags when cloning a request
Patch-Mainline: never, SLE12-SP3 specific
References: bsc#1088087, bsc#1103156

When cloning a request we should be copying over the 'cmd_flags'
from the original request; we need to modify the flags ourselves
so there is not much sense having the block layer doing that.
This mimics upstream behaviour.

Signed-off-by: Hannes Reinecke <hare@suse.com>
---
 drivers/md/dm-mpath.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/md/dm-mpath.c b/drivers/md/dm-mpath.c
index de5705a0d539..7896e11805f1 100644
--- a/drivers/md/dm-mpath.c
+++ b/drivers/md/dm-mpath.c
@@ -561,6 +561,7 @@ static int __multipath_map(struct dm_target *ti, struct request *clone,
 		 */
 		clone->q = bdev_get_queue(bdev);
 		clone->rq_disk = bdev->bd_disk;
+		clone->cmd_flags = rq->cmd_flags | REQ_NOMERGE;
 		clone->cmd_flags |= REQ_FAILFAST_TRANSPORT;
 	} else {
 		/*
@@ -583,6 +583,7 @@ static int __multipath_map(struct dm_target *ti, struct request *clone,
 		}
 		clone->bio = clone->biotail = NULL;
 		clone->rq_disk = bdev->bd_disk;
+		clone->cmd_flags = rq->cmd_flags | REQ_NOMERGE;
 		clone->cmd_flags |= REQ_FAILFAST_TRANSPORT;
 		*__clone = clone;
 	}
-- 
2.12.3

