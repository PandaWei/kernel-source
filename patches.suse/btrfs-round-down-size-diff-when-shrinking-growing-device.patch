From: Nikolay Borisov <nborisov@suse.com>
Date: Fri, 21 Jul 2017 11:28:24 +0300
Subject: btrfs: round down size diff when shrinking/growing device
Git-commit: 0e4324a4c36b3eb5cd1f71cbbc38d888f919ebfc
Patch-mainline: v4.13-rc3
References: bsc#1043912

Further testing showed that the fix introduced in 7dfb8be11b5d ("btrfs:
Round down values which are written for total_bytes_size") was
insufficient and it could still lead to discrepancies between the
total_bytes in the super block and the device total bytes. So this patch
also ensures that the difference between old/new sizes when
shrinking/growing is also rounded down. This ensure that we won't be
subtracting/adding a non-sectorsize multiples to the superblock/device
total sizees.

Fixes: 7dfb8be11b5d ("btrfs: Round down values which are written for total_bytes_size")
Signed-off-by: Nikolay Borisov <nborisov@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
---
 fs/btrfs/volumes.c |    5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

--- a/fs/btrfs/volumes.c
+++ b/fs/btrfs/volumes.c
@@ -2696,7 +2696,8 @@ int btrfs_grow_device(struct btrfs_trans
 
 	lock_chunks(device->dev_root);
 	old_total = btrfs_super_total_bytes(super_copy);
-	diff = new_size - device->total_bytes;
+	diff = round_down(new_size - device->total_bytes,
+			  device->dev_root->sectorsize);
 
 	if (new_size <= device->total_bytes ||
 	    device->is_tgtdev_for_dev_replace) {
@@ -4389,7 +4390,7 @@ int btrfs_shrink_device(struct btrfs_dev
 	u64 diff;
 
 	new_size = round_down(new_size, root->sectorsize);
-	diff = old_size - new_size;
+	diff = round_down(old_size - new_size, root->sectorsize);
 
 	if (device->is_tgtdev_for_dev_replace)
 		return -EINVAL;
