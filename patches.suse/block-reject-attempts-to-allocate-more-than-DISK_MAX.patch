From: Christoph Hellwig <hch@lst.de>
Date: Wed, 23 Aug 2017 19:10:29 +0200
Subject: [PATCH] block: reject attempts to allocate more than DISK_MAX_PARTS
 partitions
Git-commit: de65b0123216a8e1dbe3ca1eb20a45572b9e71d9
Patch-Mainline: v4.14-rc1
References: FATE#323952, FATE#322506

Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 block/genhd.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/block/genhd.c b/block/genhd.c
index 7f520fa..d823f3f 100644
--- a/block/genhd.c
+++ b/block/genhd.c
@@ -1314,6 +1314,13 @@ struct gendisk *alloc_disk_node(int minors, int node_id)
 {
 	struct gendisk *disk;
 
+	if (minors > DISK_MAX_PARTS) {
+		printk(KERN_ERR
+			"block: can't allocated more than %d partitions\n",
+			DISK_MAX_PARTS);
+		minors = DISK_MAX_PARTS;
+	}
+
 	disk = kzalloc_node(sizeof(struct gendisk), GFP_KERNEL, node_id);
 	if (disk) {
 		if (!init_part_stats(&disk->part0)) {
-- 
1.8.5.6

